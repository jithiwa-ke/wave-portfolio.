<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô Love Wave Portfolio (Pro Keying) ‚å®Ô∏è</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --input-bg: #334155;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --gold: #f59e0b;
            --green: #10b981;
            --red: #ef4444;
            --blue: #3b82f6;
            --purple: #a855f7;
            --selected: #0ea5e9;
            
            /* Custom Colors */
            --tx-pink: #fb7185; 
            --tx-orange: #f59e0b;
            --tx-darkgreen: #047857;
            
            /* Gradients */
            --g-100: #bef264; --g-161: #86efac; --g-261: #16a34a; 

            /* Badges */
            --st-w2: rgba(16, 185, 129, 0.2);
            --st-w3: rgba(239, 68, 68, 0.2);
            --st-w4: rgba(59, 130, 246, 0.2);
            --st-w5: rgba(245, 158, 11, 0.2);
            --st-abc: rgba(168, 85, 247, 0.2);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 1400px;
            width: 100%;
            overflow-x: auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gold);
            position: relative;
        }
        .header h1 { color: var(--gold); margin: 0; font-size: 1.8rem; }
        .header p { color: var(--text-muted); margin: 5px 0 0; }
        
        .btn-reset {
            position: absolute;
            right: 0;
            top: 0;
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
            border: 1px solid var(--red);
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-reset:hover { background: var(--red); color: white; }

        .dashboard-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            border: 1px solid #475569;
            overflow-x: auto;
        }
        
        .slot-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem; 
            min-width: 1200px;
        }
        .slot-table th { 
            background-color: #334155; 
            color: var(--gold); 
            padding: 8px 4px; 
            text-align: center; 
            white-space: nowrap;
            border: 1px solid #475569;
        }
        .slot-table td { 
            padding: 4px; 
            border: 1px solid #475569; 
            vertical-align: middle;
            text-align: center;
        }
        .slot-table tr.active-slot td { 
            background-color: rgba(14, 165, 233, 0.1); 
        }
        
        /* Input Styling */
        .tbl-input {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-main);
            text-align: center;
            font-size: 0.9rem;
            padding: 6px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .tbl-input:focus {
            background: #0f172a;
            border: 1px solid var(--selected);
            outline: none;
            color: var(--gold);
            font-weight: bold;
        }
        .tbl-input::placeholder { color: #475569; }
        /* Hide number spinner */
        .tbl-input::-webkit-outer-spin-button,
        .tbl-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .tbl-input[type=number] { -moz-appearance: textfield; }
        
        .status-badge {
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            background: #334155;
            color: #ccc;
            white-space: nowrap;
            display: inline-block;
        }
        
        .target-val { display: block; margin-bottom: 2px; }
        .target-label { color: var(--text-muted); font-size: 0.75rem; margin-right: 5px; }

        .calc-wrapper {
            display: none;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .current-stock-badge {
            background-color: var(--selected);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 15px;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.3);
        }

        .wave-section {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #475569;
            opacity: 0.5;
            pointer-events: none;
            transition: 0.3s;
        }
        .wave-section.active {
            opacity: 1;
            pointer-events: auto;
            border-color: var(--gold);
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .stock-name-input {
            background-color: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--gold);
            color: var(--gold);
            font-weight: bold;
            font-size: 1.1rem;
            text-align: center;
            text-transform: uppercase;
        }

        .form-control {
            background-color: var(--input-bg);
            border: 1px solid #475569;
            color: white;
            padding: 10px;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
        }
        .form-control:focus { outline: none; border-color: var(--gold); }

        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn-next { background-color: var(--blue); color: white; }

        table.result-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; overflow: hidden; }
        .result-table th, .result-table td { padding: 8px; text-align: left; border-bottom: 1px solid #334155; }
        .price-val { font-family: monospace; color: var(--gold); text-align: right; }
        .badge-rec { background: rgba(16, 185, 129, 0.2); color: var(--green); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }

        .stats-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--gold);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            color: var(--gold);
            font-weight: bold;
            margin-top: 10px;
            display: none;
        }
        
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--green);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>üíæ Wave Portfolio (Auto-Step)</h1>
        <p>‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Ä¢ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</p>
        <button class="btn-reset" onclick="resetAllData()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <div class="dashboard-card">
        <h3 style="color:var(--text-main); margin-bottom:10px;">üìä ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏´‡∏∏‡πâ‡∏ô (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter)</h3>
        <table class="slot-table">
            <thead>
                <tr>
                    <th rowspan="2" width="3%">#</th>
                    <th rowspan="2" width="8%">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô</th>
                    <th colspan="2">Wave 1</th>
                    <th width="5%">W2</th>
                    <th width="5%">W3</th>
                    <th width="5%">W4</th>
                    <th width="5%">W5</th>
                    <th width="5%">A</th>
                    <th width="5%">B</th>
                    <th width="5%">C</th>
                    <th rowspan="2" width="10%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                    <th rowspan="2" width="25%">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Target)</th>
                </tr>
                <tr>
                    <th width="6%">Start</th>
                    <th width="6%">End</th>
                    <th colspan="7" style="background:#262f3e; color:#94a3b8; font-size:0.7rem;">(Actual Price)</th>
                </tr>
            </thead>
            <tbody id="slotTableBody">
                </tbody>
        </table>
    </div>

    <div id="calculatorArea" class="calc-wrapper">
        <div style="text-align:center;">
            <span id="currentStockBadge" class="current-stock-badge">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Slot #1</span>
        </div>

        <div class="wave-section active" id="sec-w1">
            <h3>1Ô∏è‚É£ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Wave 1</h3>
            <div class="input-group">
                <div style="grid-column: span 2;">
                    <label style="color:var(--gold);">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏ô</label>
                    <input type="text" id="stockName" class="form-control stock-name-input" oninput="updateFromCalc('name', this.value)">
                </div>
                <div>
                    <label>W1 ‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                    <input type="number" step="0.01" id="w1_start" class="form-control" oninput="updateFromCalc('w1_s', this.value)">
                </div>
                <div>
                    <label>W1 ‡∏à‡∏ö</label>
                    <input type="number" step="0.01" id="w1_end" class="form-control" oninput="updateFromCalc('w1_e', this.value)">
                </div>
            </div>
            
            <button class="btn btn-next" onclick="runCalcW2()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πâ‡∏≤ Wave 2 üîΩ</button>
            <div id="w1_stats" class="stats-box"></div>
            
            <div id="res-w2" style="display:none; margin-top:15px;">
                <h4 style="color:var(--green)">üéØ ‡πÅ‡∏ú‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á Wave 2</h4>
                <table class="result-table">
                    <thead><tr><th>Fibo</th><th>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</th><th style="text-align:right">‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr></thead>
                    <tbody id="table-w2"></tbody>
                </table>
            </div>
        </div>

        <div class="wave-section" id="sec-w2">
            <h3>2Ô∏è‚É£ ‡∏à‡∏ö Wave 2</h3>
            <div class="input-group">
                <div><label>‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á W2</label><input type="number" step="0.01" id="w2_actual" class="form-control" oninput="updateFromCalc('w2_a', this.value)"></div>
            </div>
            <button class="btn btn-next" onclick="runCalcW3()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πâ‡∏≤ W3 üöÄ</button>
            <div id="res-w3" style="display:none; margin-top:15px;">
                <h4 style="color:var(--red)">üéØ ‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≤‡∏¢ Wave 3</h4>
                <table class="result-table"><tbody id="table-w3"></tbody></table>
            </div>
        </div>

        <div class="wave-section" id="sec-w3">
            <h3>3Ô∏è‚É£ ‡∏à‡∏ö Wave 3</h3>
            <div class="input-group">
                <div><label>‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á W3</label><input type="number" step="0.01" id="w3_actual" class="form-control" oninput="updateFromCalc('w3_a', this.value)"></div>
            </div>
            <button class="btn btn-next" onclick="runCalcW4()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πâ‡∏≤ W4 üìâ</button>
            <div id="res-w4" style="display:none; margin-top:15px;">
                <h4 style="color:var(--green)">üéØ ‡πÅ‡∏ú‡∏ô‡∏£‡∏±‡∏ö Wave 4</h4>
                <table class="result-table"><tbody id="table-w4"></tbody></table>
            </div>
        </div>
        
        <div class="wave-section" id="sec-w4">
            <h3>4Ô∏è‚É£ ‡∏à‡∏ö Wave 4</h3>
            <div class="input-group">
                <div><label>‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á W4</label><input type="number" step="0.01" id="w4_actual" class="form-control" oninput="updateFromCalc('w4_a', this.value)"></div>
            </div>
            <button class="btn btn-next" onclick="runCalcW5()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πâ‡∏≤ W5 üö©</button>
            <div id="res-w5" style="display:none; margin-top:15px;">
                <h4 style="color:var(--red)">üéØ ‡πÅ‡∏ú‡∏ô‡∏Ç‡∏≤‡∏¢ Wave 5</h4>
                <div id="w5_logic" style="font-size:0.8rem; color:var(--gold);"></div>
                <table class="result-table"><tbody id="table-w5"></tbody></table>
            </div>
        </div>

        <div class="wave-section" id="sec-abc">
            <h3>üíÄ Correction (A-B-C)</h3>
            <div class="input-group">
                <div><label>‡∏¢‡∏≠‡∏î‡∏î‡∏≠‡∏¢ W5</label><input type="number" step="0.01" id="w5_actual" class="form-control" oninput="updateFromCalc('w5_a', this.value)"></div>
                <div><label>‡∏à‡∏ö A</label><input type="number" step="0.01" id="a_actual" class="form-control" oninput="updateFromCalc('a_a', this.value)"></div>
                <div><label>‡∏à‡∏ö B</label><input type="number" step="0.01" id="b_actual" class="form-control" oninput="updateFromCalc('b_a', this.value)"></div>
                <div><label>‡∏à‡∏ö C</label><input type="number" step="0.01" id="c_actual" class="form-control" oninput="updateFromCalc('c_a', this.value)"></div>
            </div>
            <button class="btn btn-next" style="background:var(--purple)" onclick="runCalcABC()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πâ‡∏≤ ABC üìâ</button>
            <div id="res-abc" style="display:none; margin-top:15px;">
                <h4 style="color:var(--gold)">üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏î‡πâ‡∏á B & ‡∏à‡∏ö C</h4>
                <table class="result-table"><tbody id="table-abc"></tbody></table>
            </div>
        </div>
    </div>
    
    <div class="save-indicator" id="saveInd">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
    authDomain: "‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
    projectId: "‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
    storageBucket: "‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
    messagingSenderId: "‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì",
    appId: "‡πÉ‡∏™‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.saveToCloud = async function(data) {
    await setDoc(doc(db, "portfolios", "main"), {
      slots: data
    });
  };

  window.loadFromCloud = async function() {
    const snap = await getDoc(doc(db, "portfolios", "main"));
    if (snap.exists()) {
      return snap.data().slots;
    }
    return null;
  };
</script>

<script>
    const STORAGE_KEY = 'my_wave_portfolio_sync_v12';
    let slots = [];
    let currentSlotIdx = -1;

    function loadFromStorage() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) { slots = JSON.parse(saved); } 
        else {
            slots = Array(10).fill().map((_, i) => ({
                id: i, name: "",
                w1_s: "", w1_e: "", w2_a: "", w3_a: "", w4_a: "", w5_a: "", a_a: "", b_a: "", c_a: ""
            }));
        }
    }

 async function init() {
    const cloudData = await loadFromCloud();
    if (cloudData) {
        slots = cloudData;
    } else {
        loadFromStorage();
    }
    renderTable();
}

    // --- Input Navigation Logic ---
    function focusNextInput(el) {
        const inputs = Array.from(document.querySelectorAll('.tbl-input'));
        const index = inputs.indexOf(el);
        if (index > -1 && index < inputs.length - 1) {
            inputs[index + 1].focus();
            inputs[index + 1].select(); // Select content for easy overwrite
        }
    }

    // --- 1. Update from Dashboard Input ---
    window.updateFromDash = function(idx, field, val) {
        slots[idx][field] = val;
        updateRowCalculation(idx);
        if (idx === currentSlotIdx) {
            const mapId = {
                'name': 'stockName', 'w1_s': 'w1_start', 'w1_e': 'w1_end',
                'w2_a': 'w2_actual', 'w3_a': 'w3_actual', 'w4_a': 'w4_actual',
                'w5_a': 'w5_actual', 'a_a': 'a_actual', 'b_a': 'b_actual', 'c_a': 'c_actual'
            };
            if(document.getElementById(mapId[field])) {
                document.getElementById(mapId[field]).value = val;
                autoRunCalcs(); 
            }
        }
        if (idx !== currentSlotIdx) selectSlot(idx);
        saveToStorage();
    };

    // --- 2. Update from Calculator Input ---
    window.updateFromCalc = function(field, val) {
        if (currentSlotIdx === -1) return;
        slots[currentSlotIdx][field] = val;
        const dashInputId = `dash_${field}_${currentSlotIdx}`;
        const dashInput = document.getElementById(dashInputId);
        if(dashInput) dashInput.value = val;
        updateRowCalculation(currentSlotIdx);
        autoRunCalcs();
        saveToStorage();
    };

    function updateRowCalculation(idx) {
        const s = slots[idx];
        const statusId = `status_${idx}`;
        const targetId = `target_${idx}`;
        
        let status = "-";
        let nextTarget = "-";
        let badgeBg = "#334155"; let badgeColor = "#ccc";

        if (s.w1_s && s.w1_e && parseFloat(s.w1_e) > parseFloat(s.w1_s)) {
            let w1Start = parseFloat(s.w1_s);
            let w1End = parseFloat(s.w1_e);
            let h1 = w1End - w1Start;
            
            if (!s.w2_a) { 
                status = "‡∏£‡∏≠‡∏£‡∏±‡∏ö W2"; badgeBg = "var(--st-w2)"; badgeColor = "var(--green)";
                let t618 = w1End - (h1 * 0.618);
                let t702 = w1End - (h1 * 0.702);
                let t786 = w1End - (h1 * 0.786);
                nextTarget = `
                    <span class="target-val"><span class="target-label">61.8%:</span>${t618.toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">70.2%:</span>${t702.toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">78.6%:</span>${t786.toFixed(2)}</span>`;
            } else if (!s.w3_a) {
                status = "‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢ W3"; badgeBg = "var(--st-w3)"; badgeColor = "var(--red)";
                let w2 = parseFloat(s.w2_a);
                let minW3 = w2 + h1;
                let mainW3 = w2 + (h1 * 1.618);
                let extW3 = w2 + (h1 * 2.618);
                nextTarget = `
                    <span class="target-val"><span class="target-label">Min (100%):</span>${minW3.toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">Main (161.8%):</span>${mainW3.toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">Double (261.8%):</span>${extW3.toFixed(2)}</span>`;
            } else if (!s.w4_a) {
                status = "‡∏£‡∏≠‡∏£‡∏±‡∏ö W4"; badgeBg = "var(--st-w4)"; badgeColor = "var(--blue)";
                let w2 = parseFloat(s.w2_a);
                let w3 = parseFloat(s.w3_a);
                let h3 = w3 - w2;
                let t50 = w3 - (h3 * 0.50);
                let t618 = w3 - (h3 * 0.618);
                let isOverlap = t618 <= w1End;
                nextTarget = `
                    <span class="target-val"><span class="target-label">50% W3:</span>${t50.toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">61.8% W3:</span>${t618.toFixed(2)} ${isOverlap ? '<span style="color:var(--red)">(‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏´‡∏±‡∏ß W1)</span>' : ''}</span>`;
            } else if (!s.w5_a) {
                status = "‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢ W5"; badgeBg = "var(--st-w5)"; badgeColor = "var(--gold)";
                let w3 = parseFloat(s.w3_a);
                let w4 = parseFloat(s.w4_a);
                let len1to3 = w3 - w1Start;
                let t1 = w4 + (len1to3 * 0.618);
                let t2 = w4 + h1;
                let t3 = w4 + (len1to3 * 1.618);
                nextTarget = `
                    <span class="target-val"><span class="target-label">0.618(1->3):</span>${t1.toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">=W1:</span>${t2.toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">1.618(1->3):</span>${t3.toFixed(2)}</span>`;
            } else if (!s.a_a) {
                status = "‡∏£‡∏≠‡∏à‡∏ö A"; badgeBg = "var(--st-abc)"; badgeColor = "var(--purple)";
                let w5 = parseFloat(s.w5_a);
                let w4 = parseFloat(s.w4_a);
                let h5 = w5 - w4;
                nextTarget = `
                    <span class="target-val"><span class="target-label">=W5:</span>${(w5 - h5).toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">61.8% W5:</span>${(w5 - h5*0.618).toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">1.318 W5:</span>${(w5 - h5*1.318).toFixed(2)}</span>`;
            } else if (!s.b_a) {
                status = "‡πÄ‡∏î‡πâ‡∏á‡∏Ç‡∏≤‡∏¢ B"; badgeBg = "var(--st-w3)"; badgeColor = "var(--red)";
                let w5 = parseFloat(s.w5_a);
                let a = parseFloat(s.a_a);
                let ha = w5 - a;
                nextTarget = `
                    <span class="target-val"><span class="target-label">50% (‡∏Ç‡∏≤‡∏¢1):</span>${(a + ha*0.5).toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">61.8% (‡∏Ç‡∏≤‡∏¢2):</span>${(a + ha*0.618).toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">78.6% (‡∏´‡∏°‡∏î):</span>${(a + ha*0.786).toFixed(2)}</span>`;
            } else if (!s.c_a) {
                status = "‡∏£‡∏≠‡∏£‡∏±‡∏ö C"; badgeBg = "var(--st-w2)"; badgeColor = "var(--green)";
                let w5 = parseFloat(s.w5_a);
                let a = parseFloat(s.a_a);
                let b = parseFloat(s.b_a);
                let ha = w5 - a;
                nextTarget = `
                    <span class="target-val"><span class="target-label">C=A:</span>${(b - ha).toFixed(2)}</span>
                    <span class="target-val"><span class="target-label">1.618 A:</span>${(b - ha*1.618).toFixed(2)}</span>`;
            } else {
                status = "‡∏à‡∏ö‡∏£‡∏≠‡∏ö"; nextTarget = "-";
            }
        }

        const stEl = document.getElementById(statusId);
        const tgEl = document.getElementById(targetId);
        if(stEl) {
            stEl.innerHTML = status;
            stEl.style.background = badgeBg;
            stEl.style.color = badgeColor;
        }
        if(tgEl) tgEl.innerHTML = nextTarget;
    }

    function renderTable() {
        const tbody = document.getElementById('slotTableBody');
        tbody.innerHTML = "";
        
        slots.forEach((s, i) => {
            const tr = document.createElement('tr');
            if (i === currentSlotIdx) tr.className = "active-slot";
            tr.id = `row_${i}`;
            tr.onclick = (e) => {
                if(e.target.tagName !== 'INPUT') selectSlot(i);
            };

            const ipt = (f, v, w='50px') => `
                <input id="dash_${f}_${i}" 
                       class="tbl-input" 
                       style="width:${w}" 
                       type="${f==='name'?'text':'number'}" 
                       step="0.01"
                       value="${v}" 
                       oninput="updateFromDash(${i}, '${f}', this.value)" 
                       onkeydown="if(event.key==='Enter') focusNextInput(this)"
                       placeholder="-">`;

            tr.innerHTML = `
                <td>${i + 1}</td>
                <td>${ipt('name', s.name, '80px')}</td>
                <td>${ipt('w1_s', s.w1_s)}</td>
                <td>${ipt('w1_e', s.w1_e)}</td>
                <td>${ipt('w2_a', s.w2_a)}</td>
                <td>${ipt('w3_a', s.w3_a)}</td>
                <td>${ipt('w4_a', s.w4_a)}</td>
                <td>${ipt('w5_a', s.w5_a)}</td>
                <td>${ipt('a_a', s.a_a)}</td>
                <td>${ipt('b_a', s.b_a)}</td>
                <td>${ipt('c_a', s.c_a)}</td>
                <td><span id="status_${i}" class="status-badge">-</span></td>
                <td id="target_${i}" style="font-size:0.8rem; color:var(--text-muted); font-weight:bold; text-align:left; line-height:1.4;">-</td>
            `;
            tbody.appendChild(tr);
            updateRowCalculation(i);
        });
    }

    function selectSlot(idx) {
        if(currentSlotIdx !== -1) {
            const prevRow = document.getElementById(`row_${currentSlotIdx}`);
            if(prevRow) prevRow.classList.remove('active-slot');
        }
        currentSlotIdx = idx;
        const row = document.getElementById(`row_${idx}`);
        if(row) row.classList.add('active-slot');

        document.getElementById('calculatorArea').style.display = 'block';
        const s = slots[idx];
        document.getElementById('currentStockBadge').innerText = `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Slot #${idx + 1}: ${s.name || "‡∏´‡∏∏‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà"}`;
        
        const setVal = (id, v) => document.getElementById(id).value = v;
        setVal('stockName', s.name);
        setVal('w1_start', s.w1_s); setVal('w1_end', s.w1_e);
        setVal('w2_actual', s.w2_a); setVal('w3_actual', s.w3_a);
        setVal('w4_actual', s.w4_a); setVal('w5_actual', s.w5_a);
        setVal('a_actual', s.a_a); setVal('b_actual', s.b_a); setVal('c_actual', s.c_a);

        resetSections();
        autoRunCalcs();
    }

    function autoRunCalcs() {
        const s = slots[currentSlotIdx];
        if(s.w1_s && s.w1_e) runCalcW2();
        if(s.w2_a) runCalcW3();
        if(s.w3_a) runCalcW4();
        if(s.w4_a) runCalcW5();
        if(s.w5_a) runCalcABC();
    }

  async function saveToStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(slots));
    await saveToCloud(slots);
    showSaveIndicator();
}

    
    function resetAllData() {
        if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏∏‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á 10 ‡∏ï‡∏±‡∏ß?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    function showSaveIndicator() {
        const el = document.getElementById('saveInd');
        el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0, 1000);
    }

    function resetSections() {
        ['res-w2','res-w3','res-w4','res-w5','res-abc','w1_stats'].forEach(id => document.getElementById(id).style.display = 'none');
        ['sec-w1','sec-w2','sec-w3','sec-w4','sec-abc'].forEach(id => document.getElementById(id).classList.remove('active'));
        document.getElementById('sec-w1').classList.add('active');
    }

    // --- Calc Logic ---
    function addRow(tbodyId, l, d, p, rec=false, warn=false, customColor='') {
        let style = '';
        if (customColor) style = `color:${customColor}; font-weight:bold;`;
        else if (warn) style = 'color:var(--red); font-weight:bold;';
        
        let badge = rec ? '<span class="badge-rec">‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</span>' : '';
        if(warn) badge = '‚õî';
        
        document.getElementById(tbodyId).innerHTML += `
            <tr style="${warn ? 'background:rgba(239,68,68,0.1)' : ''}">
                <td style="${style}">${l}</td>
                <td style="${style}">${d} ${badge}</td>
                <td class="price-val" style="${style}">${p.toFixed(2)}</td>
            </tr>`;
    }

    function runCalcW2() {
        let s = parseFloat(document.getElementById('w1_start').value);
        let e = parseFloat(document.getElementById('w1_end').value);
        if(!s || !e || e<=s) return;
        let h = e - s; let pct = (h/s)*100;
        
        document.getElementById('w1_stats').style.display = 'block';
        document.getElementById('w1_stats').innerText = `üî• ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤ +${h.toFixed(2)} ‡∏à‡∏∏‡∏î (+${pct.toFixed(2)}%)`;
        document.getElementById('table-w2').innerHTML = "";
        
        addRow('table-w2', '61.8%', 'Golden Zone', e - h*0.618, true, false, 'var(--tx-pink)');
        addRow('table-w2', '70.2%', '‡∏£‡∏±‡∏ö‡∏•‡∏∂‡∏Å', e - h*0.702, false, false, 'var(--tx-orange)');
        addRow('table-w2', '78.6%', '‡∏£‡∏±‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢', e - h*0.786, false, false, 'var(--tx-darkgreen)');
        addRow('table-w2', '88.7%', 'Stop Loss', e - h*0.887, false, true);

        document.getElementById('res-w2').style.display = 'block';
        document.getElementById('sec-w2').classList.add('active');
    }

    function runCalcW3() {
        let s = parseFloat(document.getElementById('w1_start').value);
        let e = parseFloat(document.getElementById('w1_end').value);
        let w2 = parseFloat(document.getElementById('w2_actual').value);
        if(!w2) return;
        let h = e - s;
        document.getElementById('table-w3').innerHTML = "";
        
        addRow('table-w3', '100%', '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (Min)', w2 + h, false, false, 'var(--g-100)');
        addRow('table-w3', '161.8%', '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (Main)', w2 + h*1.618, true, false, 'var(--g-161)');
        addRow('table-w3', '200%', '2 ‡πÄ‡∏ó‡πà‡∏≤ (Double)', w2 + h*2.0, false, false, 'var(--g-200)');
        addRow('table-w3', '261.8%', '‡πÄ‡∏ß‡∏ü 3 ‡∏¢‡∏∑‡∏î', w2 + h*2.618, false, false, 'var(--g-261)');

        document.getElementById('res-w3').style.display = 'block';
        document.getElementById('sec-w3').classList.add('active');
    }

    function runCalcW4() {
        let w1End = parseFloat(document.getElementById('w1_end').value);
        let w2 = parseFloat(document.getElementById('w2_actual').value);
        let w3 = parseFloat(document.getElementById('w3_actual').value);
        if(!w3) return;
        let h3 = w3 - w2;
        let t50 = w3 - (h3 * 0.50);
        let t618 = w3 - (h3 * 0.618);
        let isOverlap = t618 <= w1End;
        
        document.getElementById('table-w4').innerHTML = "";
        addRow('table-w4', '50.0%', '‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (50% ‡∏Ç‡∏≠‡∏á W3)', t50, true);
        addRow('table-w4', '61.8%', '‡∏¢‡πà‡∏≠‡∏•‡∏∂‡∏Å', t618);
        addRow('table-w4', '‡∏´‡∏±‡∏ß W1', `‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏•‡∏∏‡∏î ${isOverlap?'(‡∏£‡∏∞‡∏ß‡∏±‡∏á)':''}`, w1End, false, isOverlap);

        document.getElementById('res-w4').style.display = 'block';
        document.getElementById('sec-w4').classList.add('active');
    }

    function runCalcW5() {
        let w1Start = parseFloat(document.getElementById('w1_start').value);
        let w1End = parseFloat(document.getElementById('w1_end').value);
        let w2 = parseFloat(document.getElementById('w2_actual').value);
        let w3 = parseFloat(document.getElementById('w3_actual').value);
        let w4 = parseFloat(document.getElementById('w4_actual').value);
        if(!w4) return;

        let h1 = w1End - w1Start;
        let h3 = w3 - w2;
        let len1to3 = w3 - w1Start;
        let t1 = w4 + (len1to3 * 0.618);
        let t2 = w4 + h1;
        let t3 = w4 + (len1to3 * 1.618);
        
        let check = (t1-w4) < h3 ? "‚úÖ ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏é" : "‚ö† ‡∏ú‡∏¥‡∏î‡∏Å‡∏é";
        document.getElementById('w5_logic').innerText = `üí° ‡∏Å‡∏é: W5 ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πâ‡∏ô‡∏Å‡∏ß‡πà‡∏≤ W3 (${h3.toFixed(2)})`;
        document.getElementById('table-w5').innerHTML = "";
        
        addRow('table-w5', '0.618(1->3)', `‡∏´‡∏•‡∏±‡∏Å ${check}`, t1, true);
        addRow('table-w5', 'W5 = W1', '‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö W1', t2);
        addRow('table-w5', '1.618(1->3)', '‡∏Å‡∏≤‡∏ß (Extended)', t3);

        document.getElementById('res-w5').style.display = 'block';
        document.getElementById('sec-abc').classList.add('active');
    }

    function runCalcABC() {
        let w5 = parseFloat(document.getElementById('w5_actual').value);
        let w4 = parseFloat(document.getElementById('w4_actual').value);
        let a = parseFloat(document.getElementById('a_actual').value);
        let b = parseFloat(document.getElementById('b_actual').value);

        document.getElementById('table-abc').innerHTML = "";
        
        if(w5 && w4) {
            let h5 = w5 - w4;
            document.getElementById('table-abc').innerHTML += `<tr><td colspan="3" style="background:#334155;color:white;font-size:0.8rem;">‡πÄ‡∏õ‡πâ‡∏≤‡∏•‡∏á A</td></tr>`;
            addRow('table-abc', '=W5 Length', '‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö W5', w5 - h5);
            addRow('table-abc', '61.8% W5', '‡∏™‡∏±‡πâ‡∏ô', w5 - h5*0.618);
            addRow('table-abc', '1.318 W5', '‡∏¢‡∏≤‡∏ß', w5 - h5*1.318);
        }
        if(a) {
            let ha = w5 - a;
            document.getElementById('table-abc').innerHTML += `<tr><td colspan="3" style="background:#334155;color:white;font-size:0.8rem;">‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏î‡πâ‡∏á B</td></tr>`;
            addRow('table-abc', '50.0%', '‡∏Ç‡∏≤‡∏¢ 1', a + ha*0.50, true);
            addRow('table-abc', '61.8%', '‡∏Ç‡∏≤‡∏¢ 2', a + ha*0.618, true);
            addRow('table-abc', '78.6%', '‡∏Ç‡∏≤‡∏¢‡∏´‡∏°‡∏î', a + ha*0.786);
            
            if(b) {
                document.getElementById('table-abc').innerHTML += `<tr><td colspan="3" style="background:#334155;color:white;font-size:0.8rem;">‡πÄ‡∏õ‡πâ‡∏≤‡∏•‡∏á C</td></tr>`;
                addRow('table-abc', 'C = A', '‡∏õ‡∏Å‡∏ï‡∏¥', b - ha);
                addRow('table-abc', 'C = 1.618 A', '‡∏•‡∏á‡∏•‡∏∂‡∏Å', b - ha*1.618);
            }
        }
        document.getElementById('res-abc').style.display = 'block';
    }

 init();
</script>

</body>

</html>
